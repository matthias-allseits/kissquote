<main *ngIf="position" class="col-md-12 col-lg-12 px-md-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 p-1 pb-2 mb-3 border-bottom">
        <h1 class="h2">Position {{ position.getName() }}</h1>
        <div class="mb-2 mb-md-0">
            <span *ngFor="let label of position.labels" class="badge bg-secondary">{{ label.name }}</span>
            <button (click)="openLabelModal(labelModal)" type="button" class="btn btn-tiny btn-outline-primary" ngbTooltip="Labels bearbeiten"><fa-icon [icon]="editIcon"></fa-icon></button>
        </div>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button (click)="navigateCross('backward')" type="button" class="btn btn-sm btn-outline-primary"><fa-icon [icon]="naviBackIcon"></fa-icon></button>
            </div>
            <div class="btn-group me-2">
                <button (click)="navigateCross('forward')" type="button" class="btn btn-sm btn-outline-primary"><fa-icon [icon]="naviForwardIcon"></fa-icon></button>
            </div>
        </div>
    </div>
    <ul class="nav nav-tabs">
        <li class="nav-item" *ngIf="!position.isCash">
            <a class="nav-link" [class.active]="positionTab === 'balance'" (click)="changeTab('balance')" aria-current="page">{{ tranService.trans('GLOB_BALANCE') }}</a>
        </li>
        <li class="nav-item" *ngIf="!position.isCash">
            <a class="nav-link" [class.active]="positionTab === 'sharehead'" (click)="changeTab('sharehead')">Sharehead Infos</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" [class.active]="positionTab === 'transactions'" (click)="changeTab('transactions')">{{ tranService.trans('GLOB_TRANSACTIONS') }}</a>
        </li>
    </ul>
    <div class="shadow-sm p-1 p-md-3 mb-5 bg-body rounded" [class.visually-hidden]="positionTab !== 'balance'">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-1 pb-2">
            <h4 class="pt-2">{{ tranService.trans('GLOB_BALANCE') }}</h4>
            <a [routerLink]="['/bank-account/0/position-form/' + position.id]" class="btn btn-sm btn-outline-primary">Edit this position</a>
            <div class="btn-toolbar mb-md-0">
                <div class="btn-toolbar mb-md-0">
                    <div *ngIf="position.urlSwissquote()" class="btn-group me-2">
                        <a href="{{ position.urlSwissquote() }}" target="_blank" type="button" class="btn btn-sm btn-outline-primary"><fa-icon [icon]="externalLinkIcon"></fa-icon> Swissquote</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="info-container">
            <div *ngIf="historicRates.length > 0">
                <div class="share-chart-wrapper">
                    <ul class="nav nav-tabs">
                        <li class="nav-item">
                            <a class="nav-link" [class.active]="chartTab === 'line'" (click)="changeChartTab('line')">Line</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" [class.active]="chartTab === 'bar'" (click)="changeChartTab('bar')">Bar</a>
                        </li>
                    </ul>
                    <div class="mb-3 bg-body" [class.visually-hidden]="chartTab !== 'line'">
                        <div class="info-box info-box-doubled" style="margin-right: 0; margin-bottom: 0;">
                            <app-share-chart [rates]="historicRates" [position]="position"></app-share-chart>
                        </div>
                    </div>
                    <div class="mb-3 bg-body" [class.visually-hidden]="chartTab !== 'bar'">
                        <div class="info-box info-box-doubled" style="margin-right: 0; margin-bottom: 0;">
                            <app-share-bar-chart [rates]="historicStockRates" [position]="position"></app-share-bar-chart>
                        </div>
                    </div>
                </div>
                <div class="info-box" style="margin-top: 41px;">
                    <app-bar-chart [data]="chartData"></app-bar-chart>
                </div>
            </div>
            <div class="info-box-wrapper">
                <h4>State</h4>
                <div *ngIf="position.balance" class="info-box" [class.green20]="position.balance.investment < 0">
                    <div class="row">
                        <div class="col-9">Anzahl:</div>
                        <div class="col-3"><span class="float-end">{{ position.balance.amount }}</span></div>
                    </div>
                    <div class="row">
                        <div class="col-9">Start:</div>
                        <div class="col-3"><span class="float-end">{{ position.activeFrom|date:'dd.MM.y' }}</span></div>
                    </div>
                    <div class="row" *ngIf="position.activeUntil">
                        <div class="col-9">Ende:</div>
                        <div class="col-3"><span class="float-end">{{ position.activeUntil|date:'dd.MM.y' }}</span></div>
                    </div>
                    <div class="row" *ngIf="position.activeUntil">
                        <div class="col-9">Days till end:</div>
                        <div class="col-3"><span class="float-end">{{ position.daysTillEnd()|number: '1.0' }}</span></div>
                    </div>
                    <div class="row">
                        <div class="col-9">Currency:</div>
                        <div class="col-3"><span *ngIf="position.currency" class="float-end">{{ position.currency.name }}</span></div>
                    </div>
                    <div class="row">
                        <div class="col-9">ISIN:</div>
                        <div class="col-3"><span *ngIf="position.share" class="float-end">{{ position.share.isin }}</span></div>
                    </div>
                    <div class="row">
                        <div class="col-5">Marketplace:</div>
                        <div class="col-7"><span *ngIf="position.share && position.share.marketplace" class="float-end">{{ position.share.marketplace.getName() }}</span></div>
                    </div>
                    <div class="row">
                        <div class="col-9">Erster Kurs:</div>
                        <div class="col-3"><span class="float-end">{{ position.balance.firstRate }}</span></div>
                    </div>
                    <div class="row">
                        <div class="col-9">Höchster Kurs:</div>
                        <div class="col-3"><span class="float-end"></span></div>
                    </div>
                    <div class="row">
                        <div class="col-9">Letzter Kurs<span *ngIf="position.balance.lastRate"> ({{ position.balance.lastRate.date|date: 'dd.MM.y' }})</span>:</div>
                        <div class="col-3"><span *ngIf="position.balance.lastRate" class="float-end">{{ position.balance.lastRate.rate }}</span></div>
                    </div>
                    <div *ngIf="position.balance.lastRate" class="row">
                        <div class="col-10">Yield on value {{ currentYieldOnValueSource }}</div>
                        <div class="col-2"><span class="float-end">{{ currentYieldOnValue }}%</span></div>
                    </div>
                    <div class="row">
                        <div class="col-8">Dividend payment:</div>
                        <div class="col-4"><span class="float-end">{{ position.dividendPeriodicity }}</span></div>
                    </div>
                    <div class="row">
                        <div class="col-9">Bez. Kurs Brutto:</div>
                        <div class="col-3"><span *ngIf="position.balance.investment > 0" class="float-end">{{ position.balance.averagePayedPriceGross }}</span></div>
                    </div>
                    <div class="row">
                        <div class="col-9">Bez. Kurs Netto:</div>
                        <div class="col-3"><span *ngIf="position.balance.investment > 0" class="float-end">{{ position.balance.averagePayedPriceNet }}</span></div>
                    </div>
                    <div class="row">
                        <div class="col-9">Investition:</div>
                        <div class="col-3"><span class="float-end" [class.red-text]="position.balance.investment < 0">{{ position.balance.investment|number: '1.0' }}</span></div>
                    </div>
                    <div class="row">
                        <div class="col-9">Akt. Wert:</div>
                        <div class="col-3"><span class="float-end">{{ position.actualValue()|number: '1.0' }}</span></div>
                    </div>
                    <div class="row">
                        <div class="col-9">{{ tranService.trans('GLOB_BALANCE') }}:</div>
                        <div class="col-3"><span *ngIf="position.balance.investment > 0" class="float-end" [class.red-text]="+position.investmentBalance() < 0" [class.green-text]="+position.investmentBalance() > 0">{{ position.investmentBalance() }}%</span></div>
                    </div>
                </div>
            </div>
            <div class="info-box-wrapper">
                <h4>Chancen</h4>
                <div *ngIf="position.balance" class="info-box" [class.green20]="position.balance.investment < 0">
                    <h5>{{ tranService.trans('GLOB_DIVIDENDS') }}</h5>
                    <div class="row">
                        <div class="col-8">Collected dividends:</div>
                        <div class="col-4"><span class="float-end">{{ position.balance.collectedDividends|number: '1.0' }} {{ position.balance.collectedDividendsCurrency }}</span></div>
                    </div>
                    <div class="row">
                        <div class="col-9">ROI by dividends:</div>
                        <div class="col-3"><span class="float-end" *ngIf="position.balance.investment > 0">{{ position.balance.returnOnInvestentByDividends() }}%</span></div>
                    </div>
                    <h6>Projection from last payment(s)</h6>
                    <div class="row">
                        <div class="col-8">Next payment:</div>
                        <div class="col-4"><span class="float-end">{{ position.balance.projectedNextDividendPayment|number: '1.0' }} {{ position.balance.projectedNextDividendCurrency }}</span></div>
                    </div>
                    <div class="row">
                        <div class="col-6">Yield on investment:</div>
                        <div class="col-6"><span class="float-end"><span *ngIf="position.dividendPeriodicity === 'quaterly'">(annualized) </span>{{ position.yieldOnInvestent() }}%</span></div>
                    </div>
                    <ng-container *ngIf="position.shareheadShare && shareheadDividendPayment">
                        <h6>Projection according to sharehead</h6>
                        <div class="row">
                            <div class="col-8">Next payment:</div>
                            <div class="col-4"><span class="float-end">{{ shareheadDividendPayment|number: '1.0' }} {{ position.shareheadShare.currency?.name }}</span></div>
                        </div>
                        <ng-container *ngIf="position.currency?.name === position.shareheadShare.currency?.name">
                            <div class="row">
                                <div class="col-8">Yield on investment:</div>
                                <div class="col-4"><span class="float-end">{{ (100 / position.balance.investment * +shareheadDividendPayment).toFixed(1) }}%</span></div>
                            </div>
                        </ng-container>
                        <ng-container *ngIf="position.currency?.name !== position.shareheadShare.currency?.name && shareheadCurrencyCorrectedDividendPayment">
                            <div class="row">
                                <div class="col-8">Currency-corrected:</div>
                                <div class="col-4"><span class="float-end bold">{{ shareheadCurrencyCorrectedDividendPayment|number: '1.0' }} {{ position.currency?.name }}</span></div>
                            </div>
                            <div class="row">
                                <div class="col-8">Yield on investment:</div>
                                <div class="col-4"><span class="float-end">{{ (100 / position.balance.investment * +shareheadCurrencyCorrectedDividendPayment).toFixed(1) }}%</span></div>
                            </div>
                        </ng-container>
                    </ng-container>
                    <h5 style="margin-top: 15px;">Performance</h5>
                    <div class="row">
                        <div class="col-9">Days since start:</div>
                        <div class="col-3"><span class="float-end">{{ position.daysSinceStart()|number: '1.0' }}</span></div>
                    </div>
                    <div class="row">
                        <div class="col-9">Total return per day:</div>
                        <div class="col-3"><span class="float-end" [class.red-text]="+position.totalReturnPerDay() < 0" [class.green-text]="+position.totalReturnPerDay() > 0">{{ position.totalReturnPerDay() }}</span></div>
                    </div>
                    <h5 style="margin-top: 15px;">Dividend projections</h5>
                    <ng-container *ngFor="let projection of diviProjectionYears">
                        <div class="row">
                            <div class="col-2">{{ projection.year|date:'y' }}:</div>
                            <div class="col-10"><span class="float-end">{{ projection.projectionSource }} {{ projection.projectionValue.toFixed(0) }} {{ projection.projectionCurrency }}</span></div>
                        </div>
                        <div *ngIf="projection.currencyCorrectedProjectionValue" class="row">
                            <div class="col-12"><span class="float-end bold">currency-corrected: {{ projection.currencyCorrectedProjectionValue.toFixed(0) }} {{ projection.currencyCorrectedProjectionCurrency }}</span></div>
                        </div>
                        <div class="row mb-2" *ngIf="position.balance.investment > 0">
                            <div class="col-4"></div>
                            <div class="col-6">Yield on investment: </div>
                            <div class="col-2"><span class="float-end">{{ projection.yieldFloat }}</span></div>
                        </div>
                    </ng-container>
                </div>
            </div>
            <div class="info-box-wrapper">
                <h4>Risiken</h4>
                <div *ngIf="position.balance" class="info-box">
                    <h5>{{ tranService.trans('GLOB_COSTS') }}</h5>
                    <div class="row">
                        <div class="col-9">Transaction fees total:</div>
                        <div class="col-3"><span class="float-end">{{ position.balance.transactionFeesTotal|number: '1.0' }}</span></div>
                    </div>
                </div>
                <div class="info-box" *ngIf="maxDrawdownSummary">
                    <h5>
                        Lombard value
                        <button *ngIf="position.manualDrawdown" (click)="openManualDrawdownConfirmModal(removeManualDrawdownConfirmModal)" type="button" class="btn btn-tiny btn-outline-primary float-end" ngbTooltip="Remove manual drawdown"><fa-icon [icon]="deleteIcon"></fa-icon></button>
                        <button *ngIf="!position.manualDrawdown" (click)="openManualDrawdownModal(manualDrawdownFormModal)" type="button" class="btn btn-tiny btn-outline-primary float-end" ngbTooltip="Set manual drawdown"><fa-icon [icon]="addIcon"></fa-icon></button>
                    </h5>
                    <div class="row">
                        <div class="col-6">Post corona top:</div>
                        <div class="col-3">{{ maxDrawdownSummary.postCoronaTop.date|date: 'dd.MM.YY' }}</div>
                        <div class="col-3"><span class="float-end">{{ maxDrawdownSummary.postCoronaTop.rate }}</span></div>
                    </div>
                    <div class="row">
                        <div class="col-7">Post corona top value:</div>
                        <div class="col-5"><span class="float-end">{{ maxDrawdownSummary.postCoronaTopValue|number: '1.0' }} {{ position.currency?.name }}</span></div>
                    </div>
                    <div class="row">
                        <div class="col-9">Max. drawdown:</div>
                        <div class="col-3"><span class="float-end">{{ maxDrawdownSummary.maxDrawdown }}%</span></div>
                    </div>
                    <div class="row">
                        <div class="col-3">Method:</div>
                        <div class="col-9"><span class="float-end">{{ maxDrawdownSummary.method }}</span></div>
                    </div>
                    <div class="row" [class.red-text]="+position.actualValue() < maxDrawdownSummary.maxDrawdownValue">
                        <div class="col-7">Max. drawdown value:</div>
                        <div class="col-5"><span class="float-end">{{ maxDrawdownSummary.maxDrawdownValue|number: '1.0' }} {{ position.currency?.name }}</span></div>
                    </div>
                    <div class="row">
                        <div class="col-7">Lombard value:</div>
                        <div class="col-5"><span class="float-end">{{ maxDrawdownSummary.lombardValue|number: '1.0' }} {{ position.currency?.name }}</span></div>
                    </div>
                    <div class="row">
                        <div class="col-10">Lombard value from investment:</div>
                        <div class="col-2"><span class="float-end">{{ maxDrawdownSummary.lombardValueFromInvestment }}%</span></div>
                    </div>
                    <div class="row">
                        <div class="col-10">Lombard value from post corona top:</div>
                        <div class="col-2"><span class="float-end">{{ maxDrawdownSummary.lombardValueFromPostCoronaTop }}%</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="shadow-sm p-1 p-md-3 mb-5 bg-body rounded" [class.visually-hidden]="positionTab !== 'sharehead'">
        <ng-container *ngIf="position.shareheadShare">
            <app-sharehead-share-info [shareheadShare]="position.shareheadShare" (removeInquiry)="openShareheadConfirmModal(removeShareheadConfirmModal)"></app-sharehead-share-info>
        </ng-container>
        <ng-container *ngIf="!position.shareheadShare">
            Verbinden Sie Ihre Position mit einem Sharehead-Share
            <div class="mt-3">
                share-search is deactivated for performance reasons
<!--                <app-sharehead-share-search (selectedShare)="selectShareheadShare($event)"></app-sharehead-share-search>-->
            </div>
        </ng-container>
    </div>
    <div class="shadow-sm p-1 p-md-3 mb-5 bg-body rounded" [class.visually-hidden]="positionTab !== 'transactions'">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-1 pb-2">
            <h4 class="pt-2">{{ tranService.trans('GLOB_TRANSACTIONS') }}</h4>
            <div class="btn-toolbar mb-2 mb-md-0">
                <div class="btn-group me-2">
                    <button *ngIf="!position.isCash" [routerLink]="'/position/' + position.id + '/transaction-form'" type="button" class="btn btn-sm btn-outline-primary">Add Transaction</button>
                    <button *ngIf="position.isCash" [routerLink]="'/position/' + position.id + '/cash-transaction-form'" type="button" class="btn btn-sm btn-outline-primary">Add Transaction</button>
                </div>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                <tr>
                    <th scope="col">Date</th>
                    <th scope="col">Title</th>
                    <th scope="col"><span class="float-end">Quantity</span></th>
                    <th scope="col"><span class="float-end">Rate</span></th>
                    <th scope="col" class="d-none d-md-table-cell"><span class="float-end">Fee/Tax</span></th>
                    <th scope="col" class="d-none d-md-table-cell">Currency</th>
                    <th scope="col" style="width: 35px;"></th>
                    <th scope="col" style="width: 35px;"></th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let transaction of position.transactions">
                    <td>{{ transaction.date|date:'dd.MM.y' }}</td>
                    <td>{{ transaction.title }}</td>
                    <td><span class="float-end">{{ transaction.quantity }}</span></td>
                    <td><span class="float-end">{{ transaction.rate }}</span></td>
                    <td class="d-none d-md-table-cell"><span class="float-end">{{ transaction.fee }}</span></td>
                    <td class="d-none d-md-table-cell"><span>{{ transaction.currency?.name }}</span></td>
                    <td *ngIf="!position.isCash"><span class="float-end"><button [routerLink]="'/position/' + position.id + '/transaction-form/' + transaction.id" type="button" class="btn btn-sm btn-outline-primary" ngbTooltip="Bearbeiten"><fa-icon [icon]="editIcon"></fa-icon></button></span></td>
                    <td *ngIf="position.isCash"><span class="float-end"><button [routerLink]="'/position/' + position.id + '/cash-transaction-form/' + transaction.id" type="button" class="btn btn-sm btn-outline-primary" ngbTooltip="Bearbeiten"><fa-icon [icon]="editIcon"></fa-icon></button></span></td>
                    <td><span class="float-end"><button (click)="openModal(removeTransactionConfirmModal, transaction)" type="button" class="btn btn-sm btn-outline-primary" ngbTooltip="Löschen"><fa-icon [icon]="deleteIcon"></fa-icon></button></span></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<ng-template #removeTransactionConfirmModal>
    <div class="modal-body text-center">
        <p>Wollen Sie diese Transaktion wirklich löschen?</p>
        <button type="button" class="btn btn-default" (click)="confirm()">{{ tranService.trans('GLOB_YES') }}</button>
        <button type="button" class="btn btn-primary" (click)="decline()">{{ tranService.trans('GLOB_NO') }}</button>
    </div>
</ng-template>

<ng-template #removeShareheadConfirmModal>
    <div class="modal-body text-center">
        <p>Wollen Sie diese Verknüpfung wirklich löschen?</p>
        <button type="button" class="btn btn-default" (click)="confirmShareheadRemoving()">{{ tranService.trans('GLOB_YES') }}</button>
        <button type="button" class="btn btn-primary" (click)="decline()">{{ tranService.trans('GLOB_NO') }}</button>
    </div>
</ng-template>

<ng-template #manualDrawdownFormModal>
    <div *ngIf="position && position.share" class="modal-body">
        <p>Set your manual maximum drawdown for your position &laquo;{{ position.share.name }}&raquo;:</p>
        <form [formGroup]="manualDrawdownForm">
            <div class="mb-3">
                <label for="drawdown-amount-input" class="form-label"></label>
                <input formControlName="amount" id="drawdown-amount-input" class="form-control" type="text" name="amount" value="">
            </div>
            <div class="row">
                <div class="col-6">
                    <button type="button" class="btn btn-default" (click)="cancelModal()">{{ tranService.trans('GLOB_CANCEL') }}</button>
                </div>
                <div class="col-6">
                    <button type="button" class="btn btn-primary float-end" (click)="persistManualDrawdown()">{{ tranService.trans('GLOB_SAVE') }}</button>
                </div>
            </div>
        </form>
    </div>
</ng-template>

<ng-template #removeManualDrawdownConfirmModal>
    <div class="modal-body text-center">
        <p>Wollen Sie diesen manuellen Drawdown wirklich löschen?</p>
        <button type="button" class="btn btn-default" (click)="confirmManualDrawdownRemoving()">{{ tranService.trans('GLOB_YES') }}</button>
        <button type="button" class="btn btn-primary" (click)="decline()">{{ tranService.trans('GLOB_NO') }}</button>
    </div>
</ng-template>

<ng-template #labelModal>
    <div *ngIf="position && position.share" class="modal-body">
        <p>Modify the labels for your position &laquo;{{ position.share.name }}&raquo;</p>
        <div *ngFor="let label of position.labels" class="row" style="margin-bottom: 5px;">
            <div class="col-9"><span class="badge bg-secondary">{{ label.name }}</span></div>
            <div class="col-3"><button (click)="deleteLabel(label)" type="button" class="btn btn-sm btn-outline-primary" ngbTooltip="Label entfernen"><fa-icon [icon]="deleteIcon"></fa-icon></button></div>
        </div>
        <div class="row">
            <div class="col-9"></div>
            <div class="col-3">
                <div class="dropdown">
                    <button (click)="toggleLabelsDropdown()" type="button" class="btn btn-sm btn-outline-primary" id="dropdownMenuLabels" ngbTooltip="Label hinzufügen"><fa-icon [icon]="addIcon"></fa-icon></button>
                    <ul [class.show]="showLabelsDropdown" class="dropdown-menu" aria-labelledby="dropdownMenuLabels">
                        <li *ngFor="let label of allLabels"><span (click)="addLabel(label)" class="dropdown-item">{{ label.name }}</span></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</ng-template>
